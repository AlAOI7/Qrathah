<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>حصر الأسر في قراضة</title>
    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/css/bootstrap.min.css">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Custom CSS -->
    <style>
        :root {
            --primary-color: #2c3e50;
            --secondary-color: #3498db;
            --accent-color: #e74c3c;
            --light-color: #ecf0f1;
            --success-color: #27ae60;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f8f9fa;
            color: #333;
            line-height: 1.6;
        }
        
        .navbar {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        
        .navbar-brand {
            font-weight: 700;
            font-size: 1.5rem;
        }
        
        .hero-section {
            background: linear-gradient(rgba(44, 62, 80, 0.8), rgba(52, 152, 219, 0.8)), url('https://images.unsplash.com/photo-1518837695005-2083093ee35b?ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxwaG90by1wYWdlfHx8fGVufDB8fHx8fA%3D%3D&auto=format&fit=crop&w=1470&q=80');
            background-size: cover;
            background-position: center;
            color: white;
            padding: 80px 0;
            text-align: center;
            margin-bottom: 40px;
        }
        
        .card {
            border: none;
            border-radius: 12px;
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.08);
            transition: transform 0.3s ease;
            margin-bottom: 20px;
        }
        
        .card:hover {
            transform: translateY(-5px);
        }
        
        .card-header {
            background: linear-gradient(135deg, var(--secondary-color), var(--primary-color));
            color: white;
            border-radius: 12px 12px 0 0 !important;
            font-weight: 600;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, var(--secondary-color), var(--primary-color));
            border: none;
            border-radius: 30px;
            padding: 10px 25px;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }
        
        .btn-success {
            background: linear-gradient(135deg, var(--success-color), #2ecc71);
            border: none;
            border-radius: 30px;
            padding: 10px 25px;
            font-weight: 600;
        }
        
        .btn-danger {
            background: linear-gradient(135deg, var(--accent-color), #c0392b);
            border: none;
            border-radius: 30px;
            padding: 10px 25px;
            font-weight: 600;
        }
        
        .btn-warning {
            background: linear-gradient(135deg, #f39c12, #e67e22);
            border: none;
            border-radius: 30px;
            padding: 10px 25px;
            font-weight: 600;
        }
        
        .table thead th {
            background-color: var(--primary-color);
            color: white;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        
        .modal-header {
            background: linear-gradient(135deg, var(--secondary-color), var(--primary-color));
            color: white;
        }
        
        .toast {
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }
        
        .area-badge {
            font-size: 1.1rem;
            padding: 10px 20px;
            border-radius: 30px;
            margin: 5px;
        }
        
        .footer {
            background-color: var(--primary-color);
            color: white;
            padding: 20px 0;
            margin-top: 40px;
        }
        
        .stats-card {
            text-align: center;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
        }
        
        .stats-card i {
            font-size: 2.5rem;
            margin-bottom: 15px;
        }
        
        .stats-number {
            font-size: 2rem;
            font-weight: 700;
        }
        
        .action-buttons {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin: 20px 0;
        }
        
        .action-buttons .btn {
            min-width: 150px;
        }
        
        .radio-group {
            display: flex;
            gap: 20px;
            margin-top: 10px;
        }
        
        .radio-group label {
            display: flex;
            align-items: center;
            cursor: pointer;
        }
        
        .radio-group input {
            margin-left: 8px;
        }
        
        .table-container {
            max-height: 600px;
            overflow-y: auto;
        }
        
        .wife-name-field {
            display: none;
        }
        
        .danger-zone {
            border: 2px dashed #e74c3c;
            border-radius: 12px;
            padding: 20px;
            margin-top: 30px;
            background-color: #fff5f5;
        }
        
        @media (max-width: 768px) {
            .hero-section {
                padding: 50px 0;
            }
            
            .hero-section h1 {
                font-size: 1.8rem;
            }
            
            .action-buttons {
                flex-direction: column;
                align-items: center;
            }
            
            .action-buttons .btn {
                width: 100%;
                max-width: 250px;
            }
            
            .table-container {
                max-height: 400px;
            }
        }
    </style>
</head>
<body>
    <!-- Navbar -->
    <nav class="navbar navbar-expand-lg navbar-dark">
        <div class="container">
            <a class="navbar-brand" href="#">
                <i class="fas fa-home me-2"></i>حصر الأسر في قراضة
            </a>
            <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ml-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="#" id="showReportBtn"><i class="fas fa-table me-1"></i>عرض الكشف</a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- Hero Section -->
    <div class="hero-section">
        <div class="container">
            <h1 class="display-4 mb-4">نظام حصر الأسر في قراضة</h1>
            <p class="lead">نظام متكامل لإدارة بيانات الأسر وتصنيفها حسب المناطق</p>
        </div>
    </div>

    <!-- Main Content -->
    <div class="container">
        <!-- Action Buttons -->
        <div class="action-buttons">
            <button class="btn btn-primary btn-lg" data-toggle="modal" data-target="#areaModal">
                <i class="fas fa-map-marker-alt me-2"></i>تحديد المنطقة
            </button>
            <button class="btn btn-success btn-lg" data-toggle="modal" data-target="#familyFormModal">
                <i class="fas fa-plus-circle me-2"></i>إضافة أسرة جديدة
            </button>
        </div>

        <!-- Selected Area Display -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-body text-center">
                        <h5 class="card-title">المنطقة المحددة</h5>
                        <div id="selectedAreaDisplay" class="area-badge bg-secondary text-white">
                            لم يتم تحديد منطقة بعد
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Statistics Cards -->
        <div class="row mb-5">
            <div class="col-md-3">
                <div class="stats-card bg-primary text-white">
                    <i class="fas fa-users"></i>
                    <div class="stats-number" id="totalFamilies">0</div>
                    <div>إجمالي الأسر</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stats-card bg-success text-white">
                    <i class="fas fa-male"></i>
                    <div class="stats-number" id="totalMales">0</div>
                    <div>رب أسرة ذكر</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stats-card bg-info text-white">
                    <i class="fas fa-female"></i>
                    <div class="stats-number" id="totalFemales">0</div>
                    <div>رب أسرة أنثى</div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="stats-card bg-warning text-white">
                    <i class="fas fa-user-friends"></i>
                    <div class="stats-number" id="totalMembers">0</div>
                    <div>إجمالي الأفراد</div>
                </div>
            </div>
        </div>

        <!-- Danger Zone - Reset All Data -->
        <div class="row mb-5">
            <div class="col-12">
                <div class="danger-zone text-center">
                    <h4 class="text-danger mb-3"><i class="fas fa-exclamation-triangle me-2"></i>منطقة الخطر</h4>
                    <p class="mb-4">هذه العملية لا يمكن التراجع عنها. سيتم حذف جميع البيانات بشكل دائم.</p>
                    <button class="btn btn-danger btn-lg" id="resetAllDataBtn">
                        <i class="fas fa-trash-alt me-2"></i>حذف جميع البيانات
                    </button>
                </div>
            </div>
        </div>

        <!-- Families Table (Initially Hidden) -->
        <div class="row" id="reportSection" style="display: none;">
            <div class="col-12">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">كشف الأسر المسجلة</h5>
                        <div>
                            <button class="btn btn-light btn-sm mr-2" id="exportPdfBtn">
                                <i class="fas fa-file-pdf me-1"></i>تصدير PDF
                            </button>
                            <button class="btn btn-light btn-sm" id="exportExcelBtn">
                                <i class="fas fa-file-excel me-1"></i>تصدير Excel
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="table-container">
                            <table class="table table-striped table-hover" id="familiesTable">
                                <thead>
                                    <tr>
                                        <th>#</th>
                                        <th>الرقم التسلسلي</th>
                                        <th>رب الأسرة</th>
                                        <th>الجنس</th>
                                        <th>عدد أفراد الأسرة</th>
                                        <th>رقم البطاقة</th>
                                        <th>نوع البطاقة</th>
                                        <th>اسم الزوجة</th>
                                        <th>رقم الهاتف</th>
                                        <th>القرية/المحلة</th>
                                        <th>الإجراءات</th>
                                    </tr>
                                </thead>
                                <tbody id="familiesTableBody">
                                    <!-- سيتم ملؤها بالبيانات من JavaScript -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer class="footer text-center">
        <div class="container">
            <p>نظام حصر الأسر في قراضة &copy; 2023</p>
        </div>
    </footer>

    <!-- Area Selection Modal -->
    <div class="modal fade" id="areaModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">تحديد المنطقة</h5>
                    <button type="button" class="close" data-dismiss="modal">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <p class="mb-4">يرجى اختيار المنطقة المراد حصر الأسر فيها:</p>
                    <div class="row" id="areasContainer">
                        <!-- سيتم ملؤها بالمناطق من JavaScript -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Family Form Modal -->
    <div class="modal fade" id="familyFormModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">إضافة أسرة جديدة</h5>
                    <button type="button" class="close" data-dismiss="modal">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <form id="familyForm">
                        <div class="form-group">
                            <label for="headOfFamily">رب الأسرة</label>
                            <input type="text" class="form-control" id="headOfFamily" required>
                        </div>
                        <div class="form-group">
                            <label>الجنس</label>
                            <div class="radio-group">
                                <label>
                                    <input type="radio" name="gender" value="ذكر" required>
                                    ذكر
                                </label>
                                <label>
                                    <input type="radio" name="gender" value="أنثى">
                                    أنثى
                                </label>
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="familyMembers">عدد أفراد الأسرة</label>
                            <input type="number" class="form-control" id="familyMembers" min="1" required>
                        </div>
                        <div class="form-group">
                            <label for="idNumber">رقم البطاقة</label>
                            <input type="text" class="form-control" id="idNumber" required>
                        </div>
                        <div class="form-group">
                            <label for="cardType">نوع البطاقة</label>
                            <select class="form-control" id="cardType" required>
                                <option value="">اختر نوع البطاقة</option>
                                <option value="بطاقة شخصية">بطاقة شخصية</option>
                                <option value="بطاقة قديمة">بطاقة قديمة</option>
                                <option value="بطاقة ذكية">بطاقة ذكية</option>
                                <option value="جواز سفر">جواز سفر</option>
                                <option value="بطاقة انتخابية">بطاقة انتخابية</option>
                                <option value="غير ذلك">غير ذلك</option>
                            </select>
                        </div>
                        <div class="form-group wife-name-field" id="wifeNameGroup">
                            <label for="wifeName">اسم الزوجة</label>
                            <input type="text" class="form-control" id="wifeName">
                        </div>
                        <div class="form-group">
                            <label for="phoneNumber">رقم الهاتف</label>
                            <input type="tel" class="form-control" id="phoneNumber">
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">إلغاء</button>
                    <button type="button" class="btn btn-success" id="addFamilyRepeatedlyBtn">إضافة متكررة</button>
                    <button type="button" class="btn btn-primary" id="addFamilyBtn">إضافة</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Reset Confirmation Modal -->
    <div class="modal fade" id="resetConfirmationModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-danger text-white">
                    <h5 class="modal-title"><i class="fas fa-exclamation-triangle me-2"></i>تأكيد الحذف</h5>
                    <button type="button" class="close text-white" data-dismiss="modal">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <p class="alert alert-danger"><strong>تحذير:</strong> أنت على وشك حذف جميع البيانات بشكل دائم. هذه العملية لا يمكن التراجع عنها.</p>
                    <p>هل أنت متأكد من أنك تريد حذف جميع البيانات؟</p>
                    <div class="form-group">
                        <label for="confirmationText">اكتب "<strong>نعم أحذف</strong>" للتأكيد:</label>
                        <input type="text" class="form-control" id="confirmationText" placeholder="اكتب نعم أحذف هنا">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">إلغاء</button>
                    <button type="button" class="btn btn-danger" id="confirmResetBtn" disabled>حذف جميع البيانات</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Toast for Notifications -->
    <div class="toast" id="notificationToast" style="position: fixed; top: 20px; right: 20px; z-index: 9999;">
        <div class="toast-header">
            <strong class="mr-auto" id="toastTitle">إشعار</strong>
            <button type="button" class="ml-2 mb-1 close" data-dismiss="toast">
                <span>&times;</span>
            </button>
        </div>
        <div class="toast-body" id="toastMessage">
            تمت العملية بنجاح
        </div>
    </div>

    <!-- jQuery and Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.2/dist/js/bootstrap.bundle.min.js"></script>
    <!-- jsPDF for PDF export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.25/jspdf.plugin.autotable.min.js"></script>
    <!-- SheetJS for Excel export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

    <script>
        // تهيئة المتغيرات
        let selectedArea = "";
        let families = JSON.parse(localStorage.getItem('families')) || [];
        let serialCounter = parseInt(localStorage.getItem('serialCounter')) || 1;
        
        // قائمة المناطق
        const areas = [
            "السهوة", "الحومرة", "العكد", "القرية", "المخرط", 
            "حجر الشعبة", "دار المحجر", "المحاجر", "المشراح", "بيوت النحلة", 
            "حرف العريش", "حجر الجمل", "القفعة", "الرجمة", "الخسف", 
            "المائده", "دار النصر", "المنتزة", "القبة", "المقبابة"
        ];

        // دالة لتهيئة الصفحة
        $(document).ready(function() {
            initializeAreas();
            loadSelectedArea();
            updateStatistics();
            
            // أحداث الأزرار
            $('#addFamilyBtn').click(addFamily);
            $('#addFamilyRepeatedlyBtn').click(addFamilyRepeatedly);
            $('#showReportBtn').click(showReport);
            $('#exportPdfBtn').click(exportToPdf);
            $('#exportExcelBtn').click(exportToExcel);
            $('#resetAllDataBtn').click(showResetConfirmation);
            $('#confirmResetBtn').click(resetAllData);
            
            // التحقق من نص التأكيد
            $('#confirmationText').on('input', function() {
                const confirmationText = $(this).val();
                const confirmBtn = $('#confirmResetBtn');
                
                if (confirmationText === 'نعم أحذف') {
                    confirmBtn.prop('disabled', false);
                } else {
                    confirmBtn.prop('disabled', true);
                }
            });
            
            // إظهار/إخفاء حقل اسم الزوجة بناءً على الجنس
            $('input[name="gender"]').change(function() {
                toggleWifeNameField();
            });
            
            // إنشاء 200 صف افتراضي للعرض
            generateSampleData();
            
            // عرض البيانات المخزنة إذا كانت موجودة
            if (families.length > 0) {
                renderFamiliesTable();
            }
        });

        // إظهار/إخفاء حقل اسم الزوجة
        function toggleWifeNameField() {
            const gender = $('input[name="gender"]:checked').val();
            const wifeNameGroup = $('#wifeNameGroup');
            
            if (gender === 'ذكر') {
                wifeNameGroup.show();
            } else {
                wifeNameGroup.hide();
                $('#wifeName').val('');
            }
        }

        // إنشاء بيانات نموذجية للعرض
        function generateSampleData() {
            if (families.length === 0) {
                const sampleAreas = ["السهوة", "الحومرة", "العكد", "القرية ", "المخرط"];
                const sampleNames = ["أحمد محمد", "فاطمة عبد الله", "خالد إبراهيم", "سارة علي", "محمد حسن"];
                const wifeNames = ["فاطمة أحمد", "مريم خالد", "سلمى محمد", "هدى علي", "نورة عبدالله"];
                const cardTypes = ["بطاقة شخصية", "بطاقة قديمة", "بطاقة ذكية", "جواز سفر", "بطاقة انتخابية", "غير ذلك"];
                
                for (let i = 0; i < 200; i++) {
                    const randomArea = sampleAreas[Math.floor(Math.random() * sampleAreas.length)];
                    const randomName = sampleNames[Math.floor(Math.random() * sampleNames.length)];
                    const randomGender = Math.random() > 0.5 ? "ذكر" : "أنثى";
                    const randomCardType = cardTypes[Math.floor(Math.random() * cardTypes.length)];
                    const randomWifeName = randomGender === "ذكر" ? wifeNames[Math.floor(Math.random() * wifeNames.length)] : "";
                    
                    families.push({
                        serial: serialCounter++,
                        headOfFamily: randomName,
                        gender: randomGender,
                        familyMembers: Math.floor(Math.random() * 10) + 1,
                        idNumber: Math.floor(1000000000 + Math.random() * 9000000000).toString(),
                        cardType: randomCardType,
                        wifeName: randomWifeName,
                        phoneNumber: "05" + Math.floor(10000000 + Math.random() * 90000000).toString(),
                        area: randomArea,
                        timestamp: new Date().toISOString()
                    });
                }
                saveData();
                updateStatistics();
            }
        }

        // تهيئة قائمة المناطق في المودال
        function initializeAreas() {
            const container = $('#areasContainer');
            container.empty();
            
            areas.forEach(area => {
                const col = $('<div class="col-md-4 mb-3"></div>');
                const button = $(`<button class="btn btn-outline-primary btn-block area-btn">${area}</button>`);
                button.click(function() {
                    selectArea(area);
                });
                col.append(button);
                container.append(col);
            });
        }

        // تحديد المنطقة
        function selectArea(area) {
            selectedArea = area;
            localStorage.setItem('selectedArea', area);
            $('#selectedAreaDisplay').text(area).removeClass('bg-secondary').addClass('bg-primary');
            $('#areaModal').modal('hide');
            showNotification('تم التحديد', `تم تحديد المنطقة: ${area}`, 'success');
        }

        // تحميل المنطقة المحددة من التخزين المحلي
        function loadSelectedArea() {
            const savedArea = localStorage.getItem('selectedArea');
            if (savedArea) {
                selectedArea = savedArea;
                $('#selectedAreaDisplay').text(savedArea).removeClass('bg-secondary').addClass('bg-primary');
            }
        }

        // إضافة أسرة (إضافة واحدة)
        function addFamily() {
            if (!validateForm()) return;
            
            if (!selectedArea) {
                showNotification('خطأ', 'يرجى تحديد المنطقة أولاً', 'error');
                $('#areaModal').modal('show');
                return;
            }
            
            const family = getFormData();
            families.push(family);
            saveData();
            updateStatistics();
            renderFamiliesTable();
            showNotification('تمت الإضافة', 'تم إضافة الأسرة بنجاح', 'success');
            $('#familyFormModal').modal('hide');
            resetForm();
        }

        // إضافة أسرة (إضافة متكررة)
        function addFamilyRepeatedly() {
            if (!validateForm()) return;
            
            if (!selectedArea) {
                showNotification('خطأ', 'يرجى تحديد المنطقة أولاً', 'error');
                $('#areaModal').modal('show');
                return;
            }
            
            const family = getFormData();
            families.push(family);
            saveData();
            updateStatistics();
            showNotification('تمت الإضافة', 'تم إضافة الأسرة بنجاح', 'success', 2000);
            resetForm();
        }

        // الحصول على بيانات النموذج
        function getFormData() {
            const gender = $('input[name="gender"]:checked').val();
            
            return {
                serial: serialCounter++,
                headOfFamily: $('#headOfFamily').val(),
                gender: gender,
                familyMembers: parseInt($('#familyMembers').val()),
                idNumber: $('#idNumber').val(),
                cardType: $('#cardType').val(),
                wifeName: $('#wifeName').val(),
                phoneNumber: $('#phoneNumber').val(),
                area: selectedArea,
                timestamp: new Date().toISOString()
            };
        }

        // التحقق من صحة النموذج
        function validateForm() {
            const headOfFamily = $('#headOfFamily').val();
            const gender = $('input[name="gender"]:checked').val();
            const familyMembers = $('#familyMembers').val();
            const idNumber = $('#idNumber').val();
            const cardType = $('#cardType').val();
            
            if (!headOfFamily || !gender || !familyMembers || !idNumber || !cardType) {
                showNotification('خطأ', 'يرجى ملء جميع الحقول المطلوبة', 'error');
                return false;
            }
            
            return true;
        }

        // إعادة تعيين النموذج
        function resetForm() {
            $('#familyForm')[0].reset();
            $('#wifeNameGroup').hide();
        }

        // حفظ البيانات في التخزين المحلي
        function saveData() {
            localStorage.setItem('families', JSON.stringify(families));
            localStorage.setItem('serialCounter', serialCounter.toString());
        }

        // عرض الإشعارات
        function showNotification(title, message, type, duration = 3000) {
            $('#toastTitle').text(title);
            $('#toastMessage').text(message);
            
            const toast = $('#notificationToast');
            toast.removeClass('bg-success bg-danger bg-warning');
            
            if (type === 'success') {
                toast.addClass('bg-success text-white');
            } else if (type === 'error') {
                toast.addClass('bg-danger text-white');
            } else {
                toast.addClass('bg-warning text-dark');
            }
            
            toast.toast({ delay: duration });
            toast.toast('show');
        }

        // تحديث الإحصائيات
        function updateStatistics() {
            $('#totalFamilies').text(families.length);
            
            const males = families.filter(f => f.gender === 'ذكر').length;
            const females = families.filter(f => f.gender === 'أنثى').length;
            const totalMembers = families.reduce((sum, f) => sum + f.familyMembers, 0);
            
            $('#totalMales').text(males);
            $('#totalFemales').text(females);
            $('#totalMembers').text(totalMembers);
        }

        // عرض الكشف
        function showReport() {
            if (families.length === 0) {
                showNotification('لا توجد بيانات', 'لم يتم إضافة أي أسر بعد', 'warning');
                return;
            }
            
            $('#reportSection').show();
            renderFamiliesTable();
            $('html, body').animate({
                scrollTop: $('#reportSection').offset().top
            }, 500);
        }

        // عرض البيانات في الجدول
        function renderFamiliesTable() {
            const tbody = $('#familiesTableBody');
            tbody.empty();
            
            families.forEach((family, index) => {
                const row = $('<tr></tr>');
                row.append(`<td>${index + 1}</td>`);
                row.append(`<td>${family.serial}</td>`);
                row.append(`<td>${family.headOfFamily}</td>`);
                row.append(`<td>${family.gender}</td>`);
                row.append(`<td>${family.familyMembers}</td>`);
                row.append(`<td>${family.idNumber}</td>`);
                row.append(`<td>${family.cardType}</td>`);
                row.append(`<td>${family.wifeName || '-'}</td>`);
                row.append(`<td>${family.phoneNumber}</td>`);
                row.append(`<td>${family.area}</td>`);
                
                const actions = $('<td></td>');
                const deleteBtn = $('<button class="btn btn-sm btn-danger"><i class="fas fa-trash"></i></button>');
                deleteBtn.click(() => deleteFamily(index));
                actions.append(deleteBtn);
                row.append(actions);
                
                tbody.append(row);
            });
        }

        // حذف أسرة
        function deleteFamily(index) {
            if (confirm('هل أنت متأكد من حذف هذه الأسرة؟')) {
                families.splice(index, 1);
                saveData();
                updateStatistics();
                renderFamiliesTable();
                showNotification('تم الحذف', 'تم حذف الأسرة بنجاح', 'success');
            }
        }

        // عرض نافذة تأكيد حذف جميع البيانات
        function showResetConfirmation() {
            if (families.length === 0) {
                showNotification('لا توجد بيانات', 'لا توجد بيانات لحذفها', 'warning');
                return;
            }
            
            $('#confirmationText').val('');
            $('#confirmResetBtn').prop('disabled', true);
            $('#resetConfirmationModal').modal('show');
        }

        // حذف جميع البيانات
        function resetAllData() {
            // حذف البيانات من التخزين المحلي
            localStorage.removeItem('families');
            localStorage.removeItem('serialCounter');
            localStorage.removeItem('selectedArea');
            
            // إعادة تعيين المتغيرات
            families = [];
            serialCounter = 1;
            selectedArea = "";
            
            // تحديث واجهة المستخدم
            updateStatistics();
            renderFamiliesTable();
            $('#selectedAreaDisplay').text('لم يتم تحديد منطقة بعد').removeClass('bg-primary').addClass('bg-secondary');
            $('#reportSection').hide();
            
            // إغلاق نافذة التأكيد
            $('#resetConfirmationModal').modal('hide');
            
            // عرض إشعار النجاح
            showNotification('تم الحذف', 'تم حذف جميع البيانات بنجاح', 'success');
        }

        // تصدير إلى PDF مع دعم اللغة العربية
        function exportToPdf() {
            if (families.length === 0) {
                showNotification('لا توجد بيانات', 'لم يتم إضافة أي أسر بعد', 'warning');
                return;
            }
            
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            // إضافة دعم للنص العربي
            doc.setFont('Times', 'normal');
            doc.setFontSize(18);
            
            // العنوان
            doc.text('كشف الأسر في قراضة', 105, 15, { align: 'center' });
            
            // المنطقة المحددة
            doc.setFontSize(14);
            doc.text(`المنطقة: ${selectedArea}`, 105, 25, { align: 'center' });
            
            // تاريخ التصدير
            const exportDate = new Date().toLocaleDateString('ar-EG');
            doc.setFontSize(10);
            doc.text(`تاريخ التصدير: ${exportDate}`, 105, 32, { align: 'center' });
            
            // الجدول
            const tableColumn = ["#", "رب الأسرة", "الجنس", "عدد الأفراد", "رقم البطاقة", "نوع البطاقة", "اسم الزوجة", "رقم الهاتف", "المنطقة"];
            const tableRows = [];
            
            families.forEach((family, index) => {
                const familyData = [
                    index + 1,
                    family.headOfFamily,
                    family.gender,
                    family.familyMembers.toString(),
                    family.idNumber,
                    family.cardType,
                    family.wifeName || '-',
                    family.phoneNumber,
                    family.area
                ];
                tableRows.push(familyData);
            });
            
            doc.autoTable({
                head: [tableColumn],
                body: tableRows,
                startY: 40,
                styles: { 
                    font: 'Times',
                    halign: 'center',
                    direction: 'rtl'
                },
                headStyles: { 
                    fillColor: [44, 62, 80],
                    textColor: 255,
                    fontStyle: 'bold'
                },
                margin: { right: 10, left: 10 }
            });
            
            doc.save(`كشف_الأسر_${selectedArea}_${exportDate}.pdf`);
            showNotification('تم التصدير', 'تم تصدير البيانات إلى PDF بنجاح', 'success');
        }

        // تصدير إلى Excel مع توجيه من اليمين لليسار
        function exportToExcel() {
            if (families.length === 0) {
                showNotification('لا توجد بيانات', 'لم يتم إضافة أي أسر بعد', 'warning');
                return;
            }
            
            // تحضير البيانات
            const data = [
                ["#", "الرقم التسلسلي", "رب الأسرة", "الجنس", "عدد أفراد الأسرة", "رقم البطاقة", "نوع البطاقة", "اسم الزوجة", "رقم الهاتف", "القرية/المحلة"]
            ];
            
            families.forEach((family, index) => {
                data.push([
                    index + 1,
                    family.serial,
                    family.headOfFamily,
                    family.gender,
                    family.familyMembers,
                    family.idNumber,
                    family.cardType,
                    family.wifeName || '-',
                    family.phoneNumber,
                    family.area
                ]);
            });
            
            // إنشاء ورقة عمل
            const ws = XLSX.utils.aoa_to_sheet(data);
            
            // تعيين اتجاه الورقة من اليمين لليسار
            if(!ws['!views']) ws['!views'] = [];
            ws['!views'].push({rightToLeft: true});
            
            // تعيين عرض الأعمدة
            const colWidths = [
                {wch: 5},  // #
                {wch: 12}, // الرقم التسلسلي
                {wch: 20}, // رب الأسرة
                {wch: 10}, // الجنس
                {wch: 15}, // عدد أفراد الأسرة
                {wch: 15}, // رقم البطاقة
                {wch: 15}, // نوع البطاقة
                {wch: 20}, // اسم الزوجة
                {wch: 15}, // رقم الهاتف
                {wch: 20}  // القرية/المحلة
            ];
            ws['!cols'] = colWidths;
            
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "كشف الأسر");
            
            // تصدير الملف
            const exportDate = new Date().toLocaleDateString('ar-EG');
            XLSX.writeFile(wb, `كشف_الأسر_${selectedArea}_${exportDate}.xlsx`);
            showNotification('تم التصدير', 'تم تصدير البيانات إلى Excel بنجاح', 'success');
        }
    </script>
</body>
</html>
